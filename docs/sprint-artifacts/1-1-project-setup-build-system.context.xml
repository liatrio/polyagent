<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1</storyId>
    <title>Project Setup &amp; Build System</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-1-project-setup-build-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer building PolyAgent</asA>
    <iWant>a properly initialized TypeScript/Node.js project with MCP SDK integration</iWant>
    <soThat>I can start implementing MCP tools with proper type safety and build configuration</soThat>
    <tasks>
- **Task 1:** Initialize Node.js project (AC: #1, #4)
  - 1.1: Create project directory structure (src/, __tests__/, frameworks/, bin/)
  - 1.2: Run `npm init -y` and edit package.json (name, version, bin, engines, scripts)
  - 1.3: Install production dependencies (@modelcontextprotocol/sdk@1.22.0, @open-policy-agent/opa-wasm@1.10.0, js-yaml, pino, pino-pretty)
  - 1.4: Install dev dependencies (typescript@5.9.3, jest, ts-jest, eslint, prettier, @types/*)

- **Task 2:** Configure TypeScript (AC: #2, #3)
  - 2.1: Create `tsconfig.json` with strict mode, ES2022 target, output to dist/
  - 2.2: Verify `npm run build` compiles (even with empty src/)
  - 2.3: Create `src/server.ts` stub with minimal MCP server placeholder

- **Task 3:** Configure Testing (AC: #3)
  - 3.1: Create `jest.config.js` for TypeScript + Node environment
  - 3.2: Configure ts-jest preset
  - 3.3: Set test paths: `__tests__/**/*.test.ts`
  - 3.4: Verify `npm test` runs (exits 0 even with no tests)

- **Task 4:** Configure Linting &amp; Formatting (AC: #3)
  - 4.1: Create `.eslintrc.json` with TypeScript parser and recommended rules
  - 4.2: Create `.prettierrc` with consistent style (2 spaces, single quotes, trailing commas)
  - 4.3: Add lint scripts to package.json: `lint`, `lint:fix`, `format`
  - 4.4: Verify `npm run lint` passes on stub files

- **Task 5:** Initialize Git (AC: #5)
  - 5.1: Run `git init`
  - 5.2: Create `.gitignore` (node_modules, dist, .env, logs, coverage)
  - 5.3: Create initial README.md with project description
  - 5.4: Create LICENSE file (Apache 2.0)
  - 5.5: Initial commit: "chore: initialize PolyAgent MCP server project"

- **Task 6:** Create Framework Data Placeholders (AC: #4)
  - 6.1: Create `frameworks/` directory
  - 6.2: Create placeholder YAML files (empty but valid schema):
    - `frameworks/openssf-slsa.yaml`
    - `frameworks/cis-kubernetes.yaml`
    - `frameworks/nist-800-190.yaml`
  - 6.3: Each YAML includes minimal framework metadata (id, name, version, url, empty requirements array)

- **Task 7:** Validate Build &amp; Test System (AC: #3)
  - 7.1: Run `npm run build` → verify dist/ created, exits 0
  - 7.2: Run `npm test` → verify Jest runs, exits 0
  - 7.3: Run `npm run lint` → verify ESLint passes, exits 0
  - 7.4: Test watch mode: `npm run dev` → verify TypeScript recompiles on file changes
    </tasks>
  </story>

  <acceptanceCriteria>
**AC-1: TypeScript Project Initialized**
**Given** I'm starting the PolyAgent project
**When** I run project initialization
**Then** the following must exist:

- `package.json` with:
  - name: `@polyagent/mcp-server`
  - version: `0.1.0`
  - main: `dist/server.js`
  - bin: `{ "polyagent-mcp": "dist/server.js" }`
  - engines: `{ "node": ">=22.0.0" }`
  - scripts: `build`, `test`, `lint`, `dev`

- Dependencies:
  - `@modelcontextprotocol/sdk@1.22.0`
  - `@open-policy-agent/opa-wasm@1.10.0`
  - `js-yaml@^4.1.0`
  - `pino@^9.0.0`
  - `pino-pretty@^11.0.0`

- Dev Dependencies:
  - `typescript@5.9.3`
  - `@types/node@^22.0.0`
  - `@types/js-yaml@^4.0.9`
  - `jest@^29.7.0`
  - `ts-jest@^29.1.0`
  - `@types/jest@^29.5.0`
  - `eslint@^9.0.0`
  - `@typescript-eslint/parser@^8.0.0`
  - `@typescript-eslint/eslint-plugin@^8.0.0`
  - `prettier@^3.3.0`

**AC-2: TypeScript Configuration**
**Given** TypeScript project initialized
**When** `tsconfig.json` is created
**Then** configuration must include:

- `compilerOptions`:
  - `strict`: true
  - `target`: "ES2022"
  - `module`: "commonjs"
  - `moduleResolution`: "node"
  - `outDir`: "dist"
  - `rootDir`: "src"
  - `esModuleInterop`: true
  - `skipLibCheck`: true
  - `forceConsistentCasingInFileNames`: true
  - `declaration`: true
- `include`: ["src/**/*"]
- `exclude`: ["node_modules", "dist", "__tests__"]

**AC-3: Build System Works**
**Given** project structure exists
**When** I run build commands
**Then** the following must succeed:

- `npm run build`: Compiles TypeScript `src/` → `dist/`, exits 0
- `npm test`: Runs Jest (even if no tests yet), exits 0
- `npm run lint`: Runs ESLint on `src/**/*.ts`, exits 0
- `npm run dev`: Watches TypeScript and rebuilds on changes

**AC-4: Project Structure**
**Given** initialization complete
**When** I inspect the directory
**Then** structure must match:

```
/
├── package.json
├── tsconfig.json
├── jest.config.js
├── .eslintrc.json
├── .prettierrc
├── .gitignore
├── README.md
├── LICENSE (Apache 2.0)
├── src/
│   ├── server.ts          # MCP server entry point
│   ├── tools/             # MCP tool implementations (empty for now)
│   ├── lib/               # Shared libraries
│   └── types/             # TypeScript type definitions
├── __tests__/
│   ├── unit/
│   └── integration/
├── frameworks/            # Framework YAML data
│   ├── openssf-slsa.yaml
│   ├── cis-kubernetes.yaml
│   └── nist-800-190.yaml
└── bin/
    └── polyagent-mcp      # CLI entry point
```

**AC-5: Git Initialized**
**Given** project structure exists
**When** Git is initialized
**Then** repository must have:

- `.gitignore` with:
  ```
  node_modules/
  dist/
  .env
  .env.*
  *.log
  .DS_Store
  coverage/
  .nyc_output/
  ```
- Initial commit: "chore: initialize PolyAgent MCP server project"
- README.md with project description and quick start placeholder
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Developer Tool Specific Requirements - Language &amp; Runtime Support</section>
        <snippet>Primary: TypeScript/Node.js (v18+). MCP SDK is TypeScript-native, npm ecosystem for distribution. OPA Integration via @open-policy-agent/opa-wasm (WebAssembly, no external dependencies for MVP).</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Package Distribution</section>
        <snippet>npm Package: Global install via 'npm install -g @polyagent/mcp-server'. Scoped package (@polyagent) for brand consistency. Semantic versioning (semver).</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Non-Functional Requirements - NFR15: Code Quality</section>
        <snippet>TypeScript with strict type checking. Unit test coverage &gt; 70% for core functionality. Integration tests for all 3 MCP tools.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Technology Stack</section>
        <snippet>Runtime: Node.js v24.11.0 LTS (Krypton) or v22.11.0 LTS (Jod). Language: TypeScript 5.9.3. MCP Protocol: @modelcontextprotocol/sdk@1.22.0. OPA Integration: @open-policy-agent/opa-wasm@1.10.0. Distribution: npm package (@polyagent/mcp-server). Versions verified: 2025-11-19.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>ADR-005: TypeScript over Go or Python</section>
        <snippet>Decision: TypeScript/Node.js. Rationale: MCP SDK officially supports TypeScript, npm ecosystem for distribution, Async I/O fits MCP request/response pattern, familiar to target audience (DevOps engineers use Node.js), easy integration with OpenAI SDK for embeddings.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>npm Package Structure</section>
        <snippet>Package @polyagent/mcp-server with bin/polyagent-mcp CLI entry point, dist/ for compiled TypeScript, src/ containing server.ts, tools/, lib/ (opa-evaluator, rag-engine, config-manager), frameworks/ with embedded YAML files for OpenSSF SLSA, CIS Kubernetes, NIST 800-190.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics - Story 1.1</title>
        <section>Story 1.1: Project Setup &amp; Build System</section>
        <snippet>Initialize TypeScript/Node.js project with MCP SDK integration. Dependencies: @modelcontextprotocol/sdk@1.22.0 (verified 2025-11-19), @open-policy-agent/opa-wasm@1.10.0 (verified 2025-11-19), typescript@5.9.3 (latest stable, verified 2025-11-19). Node.js v24.11.0 LTS or v22.11.0 LTS required. Project structure follows architecture spec with src/server.ts, src/tools/, src/lib/, src/types/, __tests__/unit/, __tests__/integration/.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Dependencies and Integrations</section>
        <snippet>Production Dependencies: @modelcontextprotocol/sdk 1.22.0, @open-policy-agent/opa-wasm 1.10.0, js-yaml ^4.1.0, pino ^9.0.0, pino-pretty ^11.0.0. Development Dependencies: typescript 5.9.3, @types/node ^22.0.0, @types/js-yaml ^4.0.9, jest ^29.7.0, ts-jest ^29.1.0, @types/jest ^29.5.0, eslint ^9.0.0, @typescript-eslint/parser ^8.0.0, @typescript-eslint/eslint-plugin ^8.0.0, prettier ^3.3.0.</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing code - this is a greenfield project. Story 1.1 creates the initial codebase. -->
    </code>
    <dependencies>
      <npm>
        <production>
          <package name="@modelcontextprotocol/sdk" version="1.22.0" />
          <package name="@open-policy-agent/opa-wasm" version="1.10.0" />
          <package name="js-yaml" version="^4.1.0" />
          <package name="pino" version="^9.0.0" />
          <package name="pino-pretty" version="^11.0.0" />
        </production>
        <dev>
          <package name="typescript" version="5.9.3" />
          <package name="@types/node" version="^22.0.0" />
          <package name="@types/js-yaml" version="^4.0.9" />
          <package name="jest" version="^29.7.0" />
          <package name="ts-jest" version="^29.1.0" />
          <package name="@types/jest" version="^29.5.0" />
          <package name="eslint" version="^9.0.0" />
          <package name="@typescript-eslint/parser" version="^8.0.0" />
          <package name="@typescript-eslint/eslint-plugin" version="^8.0.0" />
          <package name="prettier" version="^3.3.0" />
        </dev>
      </npm>
      <runtime>
        <requirement name="Node.js" version="&gt;=22.0.0" note="v24.11.0 LTS (Krypton) or v22.11.0 LTS (Jod) verified 2025-11-19" />
      </runtime>
    </dependencies>
  </artifacts>

  <constraints>
- **TypeScript strict mode required** - Per architecture ADR-005 and NFR15, use strict type checking to prevent runtime errors
- **MCP SDK version locked** - Must use exact version @modelcontextprotocol/sdk@1.22.0 (verified 2025-11-19), API may have breaking changes
- **Node.js version** - Minimum v22.0.0 required per package.json engines field. Recommended: v24.11.0 LTS or v22.11.0 LTS
- **Package naming** - Must use scoped package name @polyagent/mcp-server per architecture (lines 447-460)
- **Project structure** - Directory layout must follow architecture specification: src/ for source, dist/ for compiled output, __tests__/ for tests, frameworks/ for YAML data, bin/ for CLI entry point
- **Testing framework** - Jest with ts-jest required per architecture and tech spec. Coverage target &gt;70% (NFR15)
- **Build output** - TypeScript must compile to CommonJS in dist/ directory with declaration files (.d.ts)
- **Git required** - Project must be git-initialized for version control (Story acceptance criteria AC-5)
  </constraints>

  <interfaces>
    <interface>
      <name>MCP Server Entry Point</name>
      <kind>Main module</kind>
      <signature>src/server.ts - MCP server initialization and startup</signature>
      <path>src/server.ts</path>
      <note>To be created in Story 1.2 (MCP Server Core Implementation). Story 1.1 creates stub file only.</note>
    </interface>
    <interface>
      <name>CLI Entry Point</name>
      <kind>Executable binary</kind>
      <signature>bin/polyagent-mcp - CLI commands (setup, verify, health, version)</signature>
      <path>bin/polyagent-mcp</path>
      <note>To be implemented in Story 1.6 (npm Package Distribution &amp; Installation)</note>
    </interface>
    <interface>
      <name>Package.json Scripts</name>
      <kind>NPM scripts</kind>
      <signature>build: tsc, test: jest, lint: eslint, dev: tsc --watch</signature>
      <path>package.json</path>
      <note>Required for AC-3 (Build System Works)</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
Testing framework: Jest with ts-jest preset for TypeScript + Node.js environment. Unit test coverage target &gt;70% per NFR15. Test files located in __tests__/unit/ and __tests__/integration/. Integration tests for all MCP tools (Epic 2-4). Tests run via `npm test` and must exit with code 0. ESLint with @typescript-eslint/parser enforces code quality. Prettier ensures consistent code formatting (2 spaces, single quotes, trailing commas).
    </standards>
    <locations>
      <location>__tests__/unit/**/*.test.ts</location>
      <location>__tests__/integration/**/*.test.ts</location>
    </locations>
    <ideas>
      <test ac="AC-1" idea="Verify package.json contains correct dependencies (MCP SDK, OPA WASM, TypeScript, Jest, ESLint)" />
      <test ac="AC-2" idea="Verify tsconfig.json has strict mode enabled and correct compiler options (ES2022, commonjs, dist output)" />
      <test ac="AC-3" idea="Integration test: Run npm run build and verify dist/ directory created with compiled .js and .d.ts files" />
      <test ac="AC-3" idea="Integration test: Run npm test with no tests and verify Jest exits with code 0" />
      <test ac="AC-3" idea="Integration test: Run npm run lint and verify ESLint passes with no errors" />
      <test ac="AC-4" idea="Verify project directory structure matches specification (src/, __tests__/, frameworks/, bin/)" />
      <test ac="AC-5" idea="Verify .gitignore contains node_modules/, dist/, .env, *.log, coverage/" />
      <test ac="AC-5" idea="Verify git repository initialized (check .git/ directory exists)" />
    </ideas>
  </tests>
</story-context>
